<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JS Heap Memory Tracker</title>

  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    h1 {
      margin-top: 0;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      background: #2a7cff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
    }

    #content {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .block {
      width: 100px;
      height: 100px;
      background: #2a7cff;
    }

    #memoryPanel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.85);
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      min-width: 280px;
    }

    #warning {
      color: #ffcc00;
      margin-top: 6px;
    }

    #critical {
      color: #ff4444;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <h1>JS Heap Memory Stress Test</h1>
  <p>
    This app allocates <b>real JS heap objects</b> that are counted by
    <code>performance.memory.usedJSHeapSize</code>.
  </p>

  <button onclick="addContent()">Add Content</button>

  <div id="content"></div>

  <div id="memoryPanel">
    <div id="memoryInfo">Memory: N/A</div>
    <div id="warning"></div>
    <div id="critical"></div>
  </div>

<script>
  /*************************
   * GLOBAL STATE
   *************************/
  const heapObjects = [];
  const content = document.getElementById('content');

  /*************************
   * ADD REAL HEAP MEMORY
   *************************/
  function addContent() {
    // Visible UI
    const block = document.createElement('div');
    block.className = 'block';
    content.appendChild(block);

    // Allocate ~10 MB of REAL JS heap memory
    // (arrays of numbers are always on-heap)
    const MB = 10;
    const itemCount = MB * 1024 * 1024 / 8; // numbers ~8 bytes

    const arr = new Array(itemCount);
    for (let i = 0; i < arr.length; i++) {
      arr[i] = Math.random(); // unique values, no optimization
    }

    heapObjects.push(arr);
  }

  /*************************
   * FREE MEMORY
   *************************/
  function freeMemory() {
    // Remove half of allocated objects
    heapObjects.splice(0, Math.floor(heapObjects.length / 2));

    // Trim UI
    while (content.children.length > 20) {
      content.removeChild(content.firstChild);
    }
  }

  /*************************
   * MEMORY MONITOR
   *************************/
  function updateMemoryStats() {
    const info = document.getElementById('memoryInfo');
    const warning = document.getElementById('warning');
    const critical = document.getElementById('critical');

    warning.textContent = '';
    critical.textContent = '';

    if (!performance.memory) {
      info.textContent = 'performance.memory not supported';
      return;
    }

    const used = performance.memory.usedJSHeapSize;
    const total = performance.memory.jsHeapSizeLimit;
    const percent = (used / total) * 100;

    info.textContent =
      `Used: ${(used / 1048576).toFixed(1)} MB / ` +
      `Limit: ${(total / 1048576).toFixed(1)} MB ` +
      `(${percent.toFixed(2)}%)`;

    if (percent > 70 && percent <= 90) {
      warning.textContent =
        'âš  High memory usage â€“ application may become unstable';
    }

    if (percent > 90) {
      critical.textContent =
        'ðŸš¨ Critical memory usage â€“ freeing memory to avoid crash';
      freeMemory();
    }
  }

  setInterval(updateMemoryStats, 1000);
</script>

</body>
</html>
